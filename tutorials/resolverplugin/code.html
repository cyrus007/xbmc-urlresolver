

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Coding the Plugin &mdash; XBMC Helper Modules v0.1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="XBMC Helper Modules v0.1.0 documentation" href="../../index.html" />
    <link rel="up" title="How to Write a urlresolver Plugin" href="index.html" />
    <link rel="next" title="Adding A Quality Setting" href="settings.html" />
    <link rel="prev" title="Analyse the Target Site" href="analyse.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="settings.html" title="Adding A Quality Setting"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="analyse.html" title="Analyse the Target Site"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">XBMC Helper Modules v0.1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Tutorials</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">How to Write a <tt class="docutils literal docutils literal docutils literal"><span class="pre">urlresolver</span></tt> Plugin</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="coding-the-plugin">
<h1>Coding the Plugin<a class="headerlink" href="#coding-the-plugin" title="Permalink to this headline">¶</a></h1>
<p>Now it is time to start actually writing some code.</p>
<p><a class="reference internal" href="../../modules/urlresolver/interfaces.html#module-urlresolver.plugnplay.interfaces" title="urlresolver.plugnplay.interfaces"><tt class="xref py py-mod docutils literal"><span class="pre">urlresolver.plugnplay.interfaces</span></tt></a> defines what methods your resolver class
needs to implement in order to work as a plugin. Head on over there to read the
full reference documentation for those interfaces.</p>
<p>The first thing to do is get a clone of the urlresolver git repository. If you
are planning on submitting code it is probably better to fork it first, then you
will be able to send pull requests with your changes. This is beyond the scope
of this tutorial so for full details please see the
<a class="reference external" href="http://help.github.com/">github help pages</a>.</p>
<p>I work under linux, and use symbolic links to let XBMC see my development
versions of addons (not sure of the best way of doing this on other operating
systems). For example, assuming the git repo was checked out in the home
directory:</p>
<div class="highlight-python"><pre>$ ln -s ~/xbmc-urlresolver/script.module.urlresolver ~/.xbmc/addons/
$ ln -s ~/xbmc-urlresolver/script.module.t0mm0.common ~/.xbmc/addons/
$ ln -s ~/xbmc-urlresolver/plugin.video.t0mm0.test ~/.xbmc/addons/</pre>
</div>
<p>After restarting XBMC your addons will be found by XBMC.</p>
<div class="section" id="skeleton">
<h2>Skeleton<a class="headerlink" href="#skeleton" title="Permalink to this headline">¶</a></h2>
<p>Lets start off by making a &#8216;skeleton&#8217; plugin.</p>
<p>Make a new file in <tt class="docutils literal"><span class="pre">script.module.urlresolver/lib/plugins</span></tt> called
<tt class="docutils literal"><span class="pre">videobb.py</span></tt> and put the following code in it:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">t0mm0.common.net</span> <span class="kn">import</span> <span class="n">Net</span>
<span class="kn">from</span> <span class="nn">urlresolver.plugnplay.interfaces</span> <span class="kn">import</span> <span class="n">UrlResolver</span>
<span class="kn">from</span> <span class="nn">urlresolver.plugnplay.interfaces</span> <span class="kn">import</span> <span class="n">PluginSettings</span>
<span class="kn">from</span> <span class="nn">urlresolver.plugnplay</span> <span class="kn">import</span> <span class="n">Plugin</span>

<span class="k">class</span> <span class="nc">MyVideobbResolver</span><span class="p">(</span><span class="n">Plugin</span><span class="p">,</span> <span class="n">UrlResolver</span><span class="p">,</span> <span class="n">PluginSettings</span><span class="p">):</span>
    <span class="n">implements</span> <span class="o">=</span> <span class="p">[</span><span class="n">UrlResolver</span><span class="p">,</span> <span class="n">PluginSettings</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;myvideobb&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="s">&#39;priority&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_media_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">media_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;media url&#39;</span>

    <span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">media_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;web url&#39;</span>

    <span class="k">def</span> <span class="nf">get_host_and_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;host&#39;</span><span class="p">,</span> <span class="s">&#39;media id&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">valid_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">host</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
</pre></div>
</td></tr></table></div>
<p>Here&#8217;s a quick explanation.</p>
<ul>
<li><p class="first"><em>Line 1</em> - import the <a class="reference internal" href="../../modules/t0mm0.common/net.html#t0mm0.common.net.Net" title="t0mm0.common.net.Net"><tt class="xref py py-class docutils literal"><span class="pre">Net</span></tt></a> routines from <a class="reference internal" href="../../modules/t0mm0.common/net.html#module-t0mm0.common.net" title="t0mm0.common.net"><tt class="xref py py-mod docutils literal"><span class="pre">t0mm0.common.net</span></tt></a>.
This lets us easy handle HTTP calls (including handling cookies and proxies)
with the minimum of code.</p>
</li>
<li><p class="first"><em>Line 2-4</em> - Import the interfaces we need to implement.</p>
</li>
<li><p class="first"><em>Line 6-7</em> - Define our plugin&#8217;s class. The classes in brackets on line 6
are classes that your plugin will inherit from. <tt class="docutils literal"><span class="pre">Plugin</span></tt> must be included
here to take care of some stuff behind the scenes, but nothing else needs to
be done regarding <tt class="docutils literal"><span class="pre">Plugin</span></tt>.</p>
<p><tt class="docutils literal"><span class="pre">implements</span></tt> must be a list of classes you
want to commit to implmenting. In this case we will implement
<a class="reference internal" href="../../modules/urlresolver/interfaces.html#urlresolver.plugnplay.interfaces.UrlResolver" title="urlresolver.plugnplay.interfaces.UrlResolver"><tt class="xref py py-class docutils literal"><span class="pre">UrlResolver</span></tt></a> (which means we can
resolve URLs - every plugin does this!) and
<a class="reference internal" href="../../modules/urlresolver/interfaces.html#urlresolver.plugnplay.interfaces.PluginSettings" title="urlresolver.plugnplay.interfaces.PluginSettings"><tt class="xref py py-class docutils literal"><span class="pre">PluginSettings</span></tt></a> (which means our
plugin can have settings. I suggest that all plugins implement
<tt class="docutils literal"><span class="pre">PluginSettings</span></tt> unless there is a good reason not to as you get the
priority setting (which doesn&#8217;t do much yet but I hope to make more use of in
the future) free. As it happens, our plugin will need custom settings to
decide which quality stream to play by default.</p>
</li>
<li><p class="first"><em>Line 8</em> - Define a human readable name for our plugin. It is used as the
name for the settings page among other things.</p>
</li>
<li><p class="first"><em>Line 10-13</em> Our plugin&#8217;s <tt class="docutils literal"><span class="pre">__init__</span></tt> method, It gets called when the plugin
is initialised. 11-12 set up the priority value from the settings, and 13
makes an instance of the <tt class="docutils literal"><span class="pre">Net</span></tt> class. The reason I do this here is that if
you need cookies then all calls to <tt class="docutils literal"><span class="pre">self.net</span></tt> will automatically keep the
same <tt class="docutils literal"><span class="pre">cookiejar</span></tt> (the jar won&#8217;t be automatically saved, but it will last the
lifetime of the plugin which is often all that is required. If you need
cookies saved between plugin runs, look at
<a class="reference internal" href="../../modules/t0mm0.common/net.html#t0mm0.common.net.Net.save_cookies" title="t0mm0.common.net.Net.save_cookies"><tt class="xref py py-meth docutils literal"><span class="pre">save_cookies()</span></tt></a>).</p>
<p>For many plugins this <tt class="docutils literal"><span class="pre">__init__</span></tt> method can be left as is.</p>
</li>
<li><p class="first"><em>Line 15-16</em> A stub for our main method. This is where the code to turn the
<tt class="docutils literal"><span class="pre">host</span></tt> and <tt class="docutils literal"><span class="pre">media_id</span></tt> into a media URL will go.</p>
</li>
<li><p class="first"><em>Line 18-19</em> A stub for the method which turns a <tt class="docutils literal"><span class="pre">host</span></tt> and <tt class="docutils literal"><span class="pre">media_id</span></tt>
into a <tt class="docutils literal"><span class="pre">web_url</span></tt>.</p>
</li>
<li><p class="first"><em>Line 21-22</em> A stub for the method which turns a <tt class="docutils literal"><span class="pre">web_url</span></tt> into a <tt class="docutils literal"><span class="pre">host</span></tt>
and <tt class="docutils literal"><span class="pre">media_id</span></tt>. <tt class="docutils literal"><span class="pre">get_host_and_id</span></tt> is the inverse of <tt class="docutils literal"><span class="pre">get_url</span></tt>.</p>
</li>
<li><p class="first"><em>Line 24-25</em> A stub for the method that determines whether this plugin is
capable of handling any given <tt class="docutils literal"><span class="pre">web_url</span></tt>.</p>
</li>
</ul>
<p>Now turn on debugging in XBMC and navigate to the &#8216;t0mm0 test addon&#8217; in
&#8216;video addons&#8217;. Check the XBMC log (I normally leave a terminal open in linux
with <tt class="docutils literal"><span class="pre">tail</span> <span class="pre">-n</span> <span class="pre">100</span> <span class="pre">-f</span> <span class="pre">~/.xbmc/temp/xbmc.log</span></tt> which shows you the log in real
time - other operating systems may vary). Scroll back a bit and you should see
something similar to the following two lines:</p>
<div class="highlight-python"><pre>18:35:03 T:122399600 M:374116352   DEBUG: urlresolver: registering plugin: myvideobb (MyVideobbResolver), as: UrlResolver (P=100)
18:35:03 T:122399600 M:374116352   DEBUG: urlresolver: registering plugin: myvideobb (MyVideobbResolver), as: PluginSettings (P=100)</pre>
</div>
<p>This shows that your new plugin is installed and initialised correctly.</p>
</div>
<div class="section" id="can-we-handle-it">
<h2>Can We Handle It?<a class="headerlink" href="#can-we-handle-it" title="Permalink to this headline">¶</a></h2>
<p>Lets fill in the <tt class="docutils literal"><span class="pre">valid_url()</span></tt> method. This is where your plugin advertises
what URLs it is capable of resolving. This method needs to return <tt class="xref docutils literal"><span class="pre">True</span></tt> if we
think we can resolve it and <tt class="xref docutils literal"><span class="pre">False</span></tt> if not.</p>
<p>We have already found a couple of URLs we know we need to handle:</p>
<ol class="arabic">
<li><p class="first"><tt class="docutils literal"><span class="pre">http://videobb.com/video/{VIDEO_ID}</span></tt></p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">http://videobb.com/watch_video.php?v={VIDEO_ID}</span></tt></p>
<p>I also noticed an embeddable URL in my travels around the net which we might
as well support:</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">http://videobb.com/e/{VIDEO_ID}</span></tt></p>
</li>
</ol>
<p>I also noticed that all of these URLs work if they start <tt class="docutils literal"><span class="pre">www.</span></tt> as well.</p>
<p>We have also already established that the regex representation of <tt class="docutils literal"><span class="pre">{video_ID}</span></tt>
is <tt class="docutils literal"><span class="pre">[0-9A-Za-z]+</span></tt> (1 or more or any digit, or upper or lower case letter).</p>
<p>So we can start to make a regular expression that will match any of these URLs.
Lets start by making one that will match URL 1:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="s">&#39;http://(www.)?videobb.com/video/[0-9A-Za-z]+&#39;</span>
</pre></div>
</div>
<p>Looks simple enough. The brackets around the &#8216;www.&#8217; followed by a question mark
makes that part optional. Lets try it out using python&#8217;s interactive
interpreter:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;http://(www.)?videobb.com/video/[0-9A-Za-z]+&#39;</span><span class="p">,</span> <span class="s">&#39;http://videobb.com/video/8FvAG6AQpHi8&#39;</span><span class="p">)</span>
<span class="go">&lt;_sre.SRE_Match object at 0xb77fcaa0&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;http://(www.)?videobb.com/video/[0-9A-Za-z]+&#39;</span><span class="p">,</span> <span class="s">&#39;http://videobb.com/watch_video.php?v=8FvAG6AQpHi8&#39;</span><span class="p">)</span>
<span class="go">None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;http://(www.)?videobb.com/video/[0-9A-Za-z]+&#39;</span><span class="p">,</span> <span class="s">&#39;http://videobb.com/e/8FvAG6AQpHi8&#39;</span><span class="p">)</span>
<span class="go">None</span>
</pre></div>
</div>
<p>As you can see, so far only the URL 1 is covered (The <tt class="docutils literal"><span class="pre">SRE_MATCH</span></tt> object will
evaluate as True and <tt class="xref docutils literal"><span class="pre">None</span></tt> will evaluate as <tt class="xref docutils literal"><span class="pre">False</span></tt>)</p>
<p>No we&#8217;ll add support for the second URL:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="s">&#39;http://(www.)?videobb.com/(video/|watch_video.php\?v=)[0-9A-Za-z]+&#39;</span>
</pre></div>
</div>
<p>The pipe character (<tt class="docutils literal"><span class="pre">|</span></tt>) means it will match either the left part of the
brackets <strong>OR</strong> the right part.</p>
<p>Lets see how we do now:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;http://(www.)?videobb.com/(video/|watch_video.php\?v=)[0-9A-Za-z]+&#39;</span><span class="p">,</span> <span class="s">&#39;http://videobb.com/video/8FvAG6AQpHi8&#39;</span><span class="p">)</span>
<span class="go">&lt;_sre.SRE_Match object at 0xb7805e78&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;http://(www.)?videobb.com/(video/|watch_video.php\?v=)[0-9A-Za-z]+&#39;</span><span class="p">,</span> <span class="s">&#39;http://videobb.com/watch_video.php?v=8FvAG6AQpHi8&#39;</span><span class="p">)</span>
<span class="go">&lt;_sre.SRE_Match object at 0xb7805a40&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;http://(www.)?videobb.com/(video/|watch_video.php\?v=)[0-9A-Za-z]+&#39;</span><span class="p">,</span> <span class="s">&#39;http://videobb.com/e/8FvAG6AQpHi8&#39;</span><span class="p">)</span>
<span class="go">None</span>
</pre></div>
</div>
<p>So now we add support for URL 3:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="s">&#39;http://(www.)?videobb.com/(e/|video/|watch_video.php\?v=)[0-9A-Za-z]+&#39;</span>
</pre></div>
</div>
<p>You can see I&#8217;ve just added one more OR in there. Now all 3 URLs I know about
will be detected by this regular expression whether it includes a www. or not:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;http://(www.)?videobb.com/(e/|video/|watch_video.php\?v=)[0-9A-Za-z]+&#39;</span><span class="p">,</span> <span class="s">&#39;http://videobb.com/video/8FvAG6AQpHi8&#39;</span><span class="p">)</span>
<span class="go">&lt;_sre.SRE_Match object at 0xb7805ec0&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;http://(www.)?videobb.com/(e/|video/|watch_video.php\?v=)[0-9A-Za-z]+&#39;</span><span class="p">,</span> <span class="s">&#39;http://videobb.com/watch_video.php?v=8FvAG6AQpHi8&#39;</span><span class="p">)</span>
<span class="go">&lt;_sre.SRE_Match object at 0xb7805a40&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;http://(www.)?videobb.com/(e/|video/|watch_video.php\?v=)[0-9A-Za-z]+&#39;</span><span class="p">,</span> <span class="s">&#39;http://videobb.com/e/8FvAG6AQpHi8&#39;</span><span class="p">)</span>
<span class="go">&lt;_sre.SRE_Match object at 0xb7805e78&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;http://(www.)?videobb.com/(e/|video/|watch_video.php\?v=)[0-9A-Za-z]+&#39;</span><span class="p">,</span> <span class="s">&#39;http://www.videobb.com/video/8FvAG6AQpHi8&#39;</span><span class="p">)</span>
<span class="go">&lt;_sre.SRE_Match object at 0xb7805e78&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;http://(www.)?videobb.com/(e/|video/|watch_video.php\?v=)[0-9A-Za-z]+&#39;</span><span class="p">,</span> <span class="s">&#39;http://different-hoster.com/video/8FvAG6AQpHi8&#39;</span><span class="p">)</span>
<span class="go">None</span>
</pre></div>
</div>
<p>We also need to return True if strings like &#8216;videobb&#8217; or &#8216;videobb.com&#8217; are
passed in the <tt class="docutils literal"><span class="pre">host</span></tt> argument. A simple:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="s">&#39;videobb&#39;</span> <span class="ow">in</span> <span class="n">host</span>
</pre></div>
</div>
<p>test will return True if this is the case.</p>
<p>So lets use that to fill in our <tt class="docutils literal"><span class="pre">valid_url()</span></tt> method. Replace the existing
stub with:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">valid_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">host</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;http://(www.)?videobb.com/&#39;</span> <span class="o">+</span>
                    <span class="s">&#39;(e/|video/|watch_video.php\?v=)&#39;</span> <span class="o">+</span>
                    <span class="s">&#39;[0-9A-Za-z]+&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;videobb&#39;</span> <span class="ow">in</span> <span class="n">host</span>
</pre></div>
</div>
<p>and add:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">re</span>
</pre></div>
</div>
<p>to the top of the file.</p>
<p>In case you are wondering why I split the regular expression on multiple lines,
it is to make it more readable. I always try and keep line lengths less than 80
characters, as suggested in <span class="target" id="index-0"></span><a class="pep reference external" href="http://www.python.org/dev/peps/pep-0008"><strong>PEP 8</strong></a>.</p>
<div class="admonition-see-also admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">If you&#8217;d like more info on regular expressions, check out the module docs
for the <a class="reference external" href="http://docs.python.org/library/re.html#module-re" title="(in Python v2.7)"><tt class="xref py py-mod docutils literal"><span class="pre">re</span></tt></a> module, or read one of the many fine tutorials on the
web such as <a class="reference external" href="http://www.regular-expressions.info/">http://www.regular-expressions.info/</a>.</p>
</div>
</div>
<div class="section" id="handling-host-media-id-or-url">
<h2>Handling host/media_id or URL<a class="headerlink" href="#handling-host-media-id-or-url" title="Permalink to this headline">¶</a></h2>
<p>Addons could know either the URL to the host page, or just the domain name (or
name) of the host and it&#8217;s media_id.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">a media_id is a unique identifier given to a piece of media by the site that
hosts it.</p>
</div>
<p>We need <tt class="docutils literal"><span class="pre">get_url()</span></tt> and <tt class="docutils literal"><span class="pre">get_host_and_id()</span></tt> in order to convert either way.</p>
<p><tt class="docutils literal"><span class="pre">get_url()</span></tt> is the easiest. We want to make a web URL out of the <tt class="docutils literal"><span class="pre">host</span></tt> and
<tt class="docutils literal"><span class="pre">media_id</span></tt>. In this case the host part will always be the same and we just
need to add the media_id on the end of it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">media_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;http://www.videobb.com/video/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">media_id</span>
</pre></div>
</div>
<p>Now for the trickier``get_host_and_id()`` part. By now you ar an expert at
regular expressions so this shoud not be too complicated!</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">get_host_and_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;//(.+?)/(?:e/|video/|watch_video.php\?v=)([0-9a-zA-Z]+)&#39;</span><span class="p">,</span>
                  <span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
</pre></div>
</td></tr></table></div>
<p>Lets break down the regex a bit. It is in three parts.</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">//(.+?)/</span></tt> grabs the <tt class="docutils literal"><span class="pre">host</span></tt> part.</li>
<li><tt class="docutils literal"><span class="pre">(?:e/|video/|watch_video.php\?v=)</span></tt> matches all the possible URLS we found
earlier but the <tt class="docutils literal"><span class="pre">?:</span></tt> at the beginning means that the group is discarded.</li>
<li><tt class="docutils literal"><span class="pre">([0-9a-zA-Z]+)</span></tt> grabs the <tt class="docutils literal"><span class="pre">media_id</span></tt> part.</li>
</ul>
<p>If there is a match, <tt class="docutils literal"><span class="pre">r.groups()</span></tt> will return a tuple containing the <tt class="docutils literal"><span class="pre">host</span></tt>
as the first element and <tt class="docutils literal"><span class="pre">media_id</span></tt> as the second. If not the method returns
False.</p>
</div>
<div class="section" id="testing-valid-url">
<h2>Testing <tt class="docutils literal"><span class="pre">valid_url()</span></tt><a class="headerlink" href="#testing-valid-url" title="Permalink to this headline">¶</a></h2>
<p>Lets add some test urls into the test addon. Under:</p>
<div class="highlight-python"><pre>elif mode == 'test':</pre>
</div>
<p>add:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">addon</span><span class="o">.</span><span class="n">add_video_item</span><span class="p">({</span><span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="s">&#39;http://videobb.com/video/8FvAG6AQpHi8&#39;</span><span class="p">},</span>
                     <span class="p">{</span><span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="s">&#39;videobb test 1&#39;</span><span class="p">})</span>
<span class="n">addon</span><span class="o">.</span><span class="n">add_video_item</span><span class="p">({</span><span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="s">&#39;http://videobb.com/watch_video.php?v=8FvAG6AQpHi8&#39;</span><span class="p">},</span>
                     <span class="p">{</span><span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="s">&#39;videobb test 2&#39;</span><span class="p">})</span>
<span class="n">addon</span><span class="o">.</span><span class="n">add_video_item</span><span class="p">({</span><span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="s">&#39;http://videobb.com/e/8FvAG6AQpHi8&#39;</span><span class="p">},</span>
                     <span class="p">{</span><span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="s">&#39;videobb test 3&#39;</span><span class="p">})</span>
<span class="n">addon</span><span class="o">.</span><span class="n">add_video_item</span><span class="p">({</span><span class="s">&#39;host&#39;</span><span class="p">:</span> <span class="s">&#39;videobb.com&#39;</span><span class="p">,</span> <span class="s">&#39;media_id&#39;</span><span class="p">:</span> <span class="s">&#39;8FvAG6AQpHi8&#39;</span><span class="p">},</span>
                     <span class="p">{</span><span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="s">&#39;videobb test 4&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>Now we can test to see if our plugin tries to resolve these links by trying to
play them in XBMC.</p>
<p>Go to &#8216;t0mm0 test addon&#8217; in &#8216;video addons&#8217;. Select &#8216;resolver settings&#8217; and
change the priority for our plugin to something lower than the existing videobb
plugin. This will ensure that when we try and play a videobb link, our
&#8216;myvideobb&#8217; plugin will be tried first (plugins are tried in priority order from
low numbers to high).</p>
<p>Now select &#8216;*test links*&#8217; and you should see the links we just added. Give one
a try. It won&#8217;t play anything because we haven&#8217;t written the code yet, but you
should see the following in the log which proves the URL is being sent to our
new plugin:</p>
<div class="highlight-python"><pre>20:38:11 T:3040648048 M:556085248  NOTICE: urlresolver: resolving using myvideobb plugin
20:38:11 T:3040648048 M:555970560   DEBUG: t0mm0 test addon: resolved to: media url</pre>
</div>
<p>If it still says <tt class="docutils literal"><span class="pre">resolving</span> <span class="pre">using</span> <span class="pre">videobb</span> <span class="pre">plugin</span></tt> you have done something
wrong. Go back and check your regular expressions and check the priority
settings.</p>
</div>
<div class="section" id="the-main-event">
<h2>The Main Event<a class="headerlink" href="#the-main-event" title="Permalink to this headline">¶</a></h2>
<p>Now lets replace the <tt class="docutils literal"><span class="pre">get_media_url()</span></tt> method with something useful:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">get_media_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">media_id</span><span class="p">):</span>
    <span class="c">#grab json info for this video</span>
    <span class="n">json_url</span> <span class="o">=</span> <span class="s">&#39;http://videobb.com/player_control/settings.php?v=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> \
                                                                <span class="n">media_id</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">http_GET</span><span class="p">(</span><span class="n">json_url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
    <span class="k">except</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">URLError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">common</span><span class="o">.</span><span class="n">addon</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="s">&#39;myvideobb: got http error </span><span class="si">%d</span><span class="s"> fetching </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">api_url</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="c">#find highest quality URL</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s">&#39;&quot;l&quot;.*?:.*?&quot;(.+?)&quot;.+?&quot;u&quot;.*?:.*?&quot;(.+?)&quot;&#39;</span><span class="p">,</span> <span class="n">json</span><span class="p">)</span>
    <span class="n">chosen_res</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">stream_url</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">res</span><span class="p">,</span> <span class="n">url</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;p&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">res</span> <span class="o">&gt;</span> <span class="n">chosen_res</span><span class="p">:</span>
                <span class="n">stream_url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;base-64&#39;</span><span class="p">)</span>
                <span class="n">chosen_res</span> <span class="o">=</span> <span class="n">res</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">common</span><span class="o">.</span><span class="n">addon</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="s">&#39;myvideobb: stream url not found&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">return</span> <span class="n">stream_url</span>
</pre></div>
</td></tr></table></div>
<p>You&#8217;ll also need to add:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">from</span> <span class="nn">urlresolver</span> <span class="kn">import</span> <span class="n">common</span>
</pre></div>
</div>
<p>to the top of the file.</p>
<p>Although we use <a class="reference internal" href="../../modules/t0mm0.common/net.html#t0mm0.common.net.Net" title="t0mm0.common.net.Net"><tt class="xref py py-class docutils literal"><span class="pre">Net</span></tt></a> to handle the network
communications, we still need to import <a class="reference external" href="http://docs.python.org/library/urllib2.html#module-urllib2" title="(in Python v2.7)"><tt class="xref py py-mod docutils literal"><span class="pre">urllib2</span></tt></a> in order to catch the
exceptions if something goes wrong.</p>
<p><tt class="docutils literal"><span class="pre">urlrsolver.common</span></tt> is imported so that we can use the logging functions.</p>
<p>This code is split into two main sections:</p>
<ol class="arabic simple">
<li><a class="reference internal" href="#grab-json"><em>Grab JSON info for this video</em></a> (lines 2-10)</li>
<li><a class="reference internal" href="#grab-url"><em>Find highest quality URL</em></a> (lines 12-27)</li>
</ol>
<div class="section" id="grab-json-info-for-this-video">
<span id="grab-json"></span><h3>Grab JSON info for this video<a class="headerlink" href="#grab-json-info-for-this-video" title="Permalink to this headline">¶</a></h3>
<p>This section of code handles grabbing the URL of the JSON information and
getting its contents.</p>
<ul class="simple">
<li><em>Line 3-4</em> - Construct the URL to fetch using the <tt class="docutils literal"><span class="pre">video_id</span></tt> we found
earlier.</li>
<li><em>Line 5-10</em> - Use <a class="reference internal" href="../../modules/t0mm0.common/net.html#t0mm0.common.net.Net" title="t0mm0.common.net.Net"><tt class="xref py py-class docutils literal"><span class="pre">Net</span></tt></a> to grab the URL&#8217;s content,
catching the exception if we get an error (such as 404 not found). Again if
there is an error we log it and return <tt class="xref docutils literal"><span class="pre">False</span></tt>.</li>
</ul>
</div>
<div class="section" id="find-highest-quality-url">
<span id="grab-url"></span><h3>Find highest quality URL<a class="headerlink" href="#find-highest-quality-url" title="Permalink to this headline">¶</a></h3>
<p>This section looks through the JSON and finds the best quality URL available.</p>
<p>Remember this from earlier:</p>
<div class="highlight-javascript"><div class="highlight"><pre>        <span class="s2">&quot;res&quot;</span><span class="o">:</span> <span class="p">[{</span>
            <span class="s2">&quot;d&quot;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="s2">&quot;l&quot;</span><span class="o">:</span> <span class="s2">&quot;240p&quot;</span><span class="p">,</span>
            <span class="s2">&quot;u&quot;</span><span class="o">:</span> <span class="s2">&quot;aHR0cDovL3MxMC52aWRlb2JiLmNvbTo4MC9zP3Y9OEZ2QUc2QVFwSGk4JnQ9MTMxMzIzOTczMCZ1PSZjPUIzOUQyOThBNzY0QkNGRTdDRThFNTExRkYyRjQ3MTFEOTY0MkRBMUJGOUNBNEQ2ODA5NDkwRkNGRTAyM0UwN0Mmcj0x&quot;</span>
        <span class="p">},</span> <span class="p">{</span>
            <span class="s2">&quot;d&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="s2">&quot;l&quot;</span><span class="o">:</span> <span class="s2">&quot;480p&quot;</span><span class="p">,</span>
            <span class="s2">&quot;u&quot;</span><span class="o">:</span> <span class="s2">&quot;aHR0cDovL3MxMC52aWRlb2JiLmNvbTo4MC9zP3Y9OEZ2QUc2QVFwSGk4JnQ9MTMxMzIzOTczMCZ1PSZjPUIzOUQyOThBNzY0QkNGRTdDRThFNTExRkYyRjQ3MTFEOTY0MkRBMUJGOUNBNEQ2ODA5NDkwRkNGRTAyM0UwN0Mmcj0y&quot;</span>
        <span class="p">}]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>(this is the beautified version, the real thing is all on a single line)</p>
<ul>
<li><p class="first"><em>Line 13</em> - We could have used
<a class="reference external" href="http://simplejson.github.com/simplejson/">simplejson</a> here but (despite its
name!) it would be more work than regular expressions.</p>
<p>We capture two values <tt class="docutils literal"><span class="pre">l</span></tt> which is the resolution, and <tt class="docutils literal"><span class="pre">u</span></tt> which is the
base64 encoded URL. We use <a class="reference external" href="http://docs.python.org/library/re.html#re.finditer" title="(in Python v2.7)"><tt class="xref py py-func docutils literal"><span class="pre">re.finditer()</span></tt></a> because there may be more than
one result which we want to loop through.</p>
</li>
<li><p class="first"><em>Line 14-15</em> - Set up some variables. <tt class="docutils literal"><span class="pre">chosen_res</span></tt> will keep track of the
currently chosen resolution, and <tt class="docutils literal"><span class="pre">stream_url</span></tt> is set to <tt class="xref docutils literal"><span class="pre">False</span></tt> so that if
the next few lines go wrong this method will return <tt class="xref docutils literal"><span class="pre">False</span></tt> and the addon
will know something went wrong.</p>
</li>
<li><p class="first"><em>Line 17</em> - Loop through all the matches we made.</p>
</li>
<li><p class="first"><em>Line 18</em> - Grab the two values from the capture groups for this match.</p>
</li>
<li><p class="first"><em>Line 19</em> - Remove any &#8216;p&#8217; from the end of the resolution. This is just a
guess, because this JSON is not documented we can not tell what all the
possible resolutions are, but the only ones I have seen are &#8216;240p&#8217; and &#8216;480p&#8217;
so i think it&#8217;s safe to assume if there are any others they will probably end
in &#8216;p&#8217;.</p>
</li>
<li><p class="first"><em>Line 20-22</em> If the resolution for this match is higher than our current
selection, set <tt class="docutils literal"><span class="pre">stream_url</span></tt> to be this URL (remember it is base64 encoded
so we need to <tt class="xref py py-func docutils literal"><span class="pre">decode()</span></tt>) and update the value in <tt class="docutils literal"><span class="pre">chosen_res</span></tt> so we
know what our currently chosen resolution is for the next time round the loop.</p>
</li>
<li><p class="first"><em>Line 23-25</em> - As usual, log the error and return <tt class="xref docutils literal"><span class="pre">False</span></tt> if the regular
expression didn&#8217;t match.</p>
</li>
</ul>
<p>There you have it - a working plugin! Try it out with one of your test links in
XBMC and you should see (as well as some video playing!) something like this in
the log:</p>
<div class="highlight-python"><pre>23:43:30 T:2916084592 M:407699456  NOTICE: urlresolver: resolving using myvideobb plugin
23:43:30 T:2916084592 M:405127168   DEBUG: t0mm0 test addon: resolved to: http://s200.videobb.com:80/s?v=8FvAG6AQpHi8&amp;t=1313275412&amp;u=&amp;c=C08FDA7D2B03F3E262C00750C5984C809642DA1BF9CA4D6809490FCFE023E07C&amp;r=2</pre>
</div>
<p>Read the next section to see how to add a quality setting.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Coding the Plugin</a><ul>
<li><a class="reference internal" href="#skeleton">Skeleton</a></li>
<li><a class="reference internal" href="#can-we-handle-it">Can We Handle It?</a></li>
<li><a class="reference internal" href="#handling-host-media-id-or-url">Handling host/media_id or URL</a></li>
<li><a class="reference internal" href="#testing-valid-url">Testing <tt class="docutils literal"><span class="pre">valid_url()</span></tt></a></li>
<li><a class="reference internal" href="#the-main-event">The Main Event</a><ul>
<li><a class="reference internal" href="#grab-json-info-for-this-video">Grab JSON info for this video</a></li>
<li><a class="reference internal" href="#find-highest-quality-url">Find highest quality URL</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="analyse.html"
                        title="previous chapter">Analyse the Target Site</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="settings.html"
                        title="next chapter">Adding A Quality Setting</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/tutorials/resolverplugin/code.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="settings.html" title="Adding A Quality Setting"
             >next</a> |</li>
        <li class="right" >
          <a href="analyse.html" title="Analyse the Target Site"
             >previous</a> |</li>
        <li><a href="../../index.html">XBMC Helper Modules v0.1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Tutorials</a> &raquo;</li>
          <li><a href="index.html" >How to Write a <tt class="docutils literal docutils literal docutils literal"><span class="pre">urlresolver</span></tt> Plugin</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, t0mm0.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>